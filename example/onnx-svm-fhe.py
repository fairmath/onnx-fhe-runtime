import onnx
import numpy as np
import onnxruntime as ort
import os

from onnx import OperatorSetIdProto

option = ort.SessionOptions()
option.register_custom_ops_library(os.getcwd()+'/../build/install/lib/libonnx-fhe-runtime.so')


sv = [[-0.5106524879439027,
  -1.2802911282352558,
  0.03570911486093786,
  -0.30594886034940616,
  -1.3016033257419999,
  -1.4081656161088978],
 [2.8348660495750453,
  -0.4968590326726214,
  1.987135324924016,
  -0.15880855371091995,
  0.38784488153046615,
  -2.154623220425309],
 [2.276870025430668,
  0.5161247285776908,
  0.7231556281920193,
  -1.9024921987680128,
  0.4754936414491742,
  -1.946404942810286],
 [0.15410264598870216,
  1.7058248593376857,
  1.4695842348181685,
  1.3514995971628045,
  -0.032330250925114046,
  0.02077486271274065],
 [-0.08548932683980848,
  1.998049542287028,
  1.8582886129852951,
  -0.5694002879737623,
  -1.5795207573125938,
  1.2651260556917339],
 [3.6293893976455553,
  0.8281534903901053,
  1.6571540655439896,
  -1.754242178612389,
  1.0098949610496601,
  -2.273542079715382],
 [-0.8776395908603403,
  -0.03519693846248355,
  -0.45209266029848816,
  -2.327552685636078,
  0.05655894958916795,
  -2.3091866239020877],
 [1.9602497011173854,
  0.9161712656046209,
  1.3581139658440287,
  -0.3413581880507418,
  1.0903629116936455,
  -1.5210912278153177],
 [-1.004578086095008,
  0.7079243669696743,
  0.9598157592278891,
  -0.335726350244996,
  2.2084505258661813,
  0.9374691635105863],
 [1.7467619484899661,
  0.5319168922188459,
  1.711619455974146,
  -1.664768915398931,
  0.6963511266524872,
  -1.0160753235112556],
 [1.2717168838523596,
  -1.4002155510135357,
  -1.3172521958309193,
  -3.5675920605586433,
  0.22966246423314007,
  -3.122109319439013],
 [-0.41728793461336045,
  -0.7524467003268688,
  -0.22693102541262844,
  -1.5950608672765578,
  1.6737481593913828,
  -2.227347932418386],
 [0.4897870107152986,
  0.8202457394862555,
  2.0332668430178322,
  -0.41465754923677656,
  -1.7072771556275985,
  0.535130464203323],
 [-1.4755720913816506,
  -0.041626034286924164,
  -1.6082559000704961,
  -3.6264092474460843,
  -0.9001156580739134,
  -2.5481466636741796],
 [-0.43394316543912015,
  -0.37905764618232096,
  0.10299108517568278,
  -0.8729342285511027,
  -1.0595791462166488,
  -0.9168794650717438],
 [-0.5891187583106163,
  0.1835118230877355,
  -0.5878940334818519,
  -2.036549833124874,
  0.3531576232226657,
  -1.2145651856711428],
 [0.8008193420634742,
  2.0670440017513796,
  1.780784584503908,
  0.020396377142206212,
  -1.9449392903707496,
  -1.5925669533939675],
 [0.3237802399825501,
  0.5525331523474403,
  -0.13627788145060582,
  -1.571459265372389,
  0.29555045097915267,
  -1.1937444178989993],
 [-1.7556526157474275,
  0.6161066540197494,
  -1.2433925732645366,
  -0.5094654337864035,
  -0.5287239854997043,
  0.005005298233223376],
 [-0.6691319818249983,
  -1.8673518263691093,
  -0.5362902613535243,
  -0.7835252125157468,
  -0.7647913869554506,
  -0.8815087564325927],
 [-1.5967415759535872,
  -0.582580915634934,
  -0.701543258273688,
  -0.23726617773414038,
  0.2609064338316734,
  -0.4755362239867218],
 [2.707662832382125,
  0.7423649162591182,
  1.243859922340642,
  -1.8663054940854664,
  0.2434565106998877,
  -3.04245124678121],
 [-0.9280668489145419,
  0.07604803989638514,
  -0.04865611673085268,
  -3.8518159580082223,
  0.3529599755389019,
  -1.4907776033348763],
 [-1.4541671851468936,
  -1.1480549061557412,
  -1.4849835949843893,
  -0.8955472272919648,
  -0.6022562028821763,
  -1.8088863081830975],
 [1.9864177923034936,
  -0.5007863824175939,
  1.4186548957885867,
  -1.8772045691212615,
  1.9070189019105557,
  -1.996376778990498],
 [-0.4751827379827468,
  -1.2184896412865855,
  -0.38417148588881,
  -1.3543167361056678,
  -1.1603250252693058,
  0.004719251265614899],
 [1.3012882536880268,
  -0.07167403655743708,
  0.8947576823139264,
  -1.9234910019471625,
  -1.0238185194890543,
  -1.5340643161930347],
 [-2.598242805361795,
  -0.8712468811149293,
  -3.172507502926025,
  -3.1209643418832456,
  -0.22674942729822584,
  -3.1342027967503925],
 [0.5962720627615816,
  0.19209038063264924,
  0.7490834081104616,
  0.09410035146441897,
  1.5971127225208108,
  1.0574126779258957],
 [1.114073950724563,
  0.24201514406779656,
  2.1348706378657445,
  -0.35848791619231646,
  -1.5304787431872526,
  -0.1602572261245815],
 [-1.6988622523508767,
  -1.764126899300082,
  -2.25704953332894,
  -2.420554508754222,
  1.4998886756751972,
  -1.7706521643646878],
 [-1.7620315988465798,
  -2.145856759849942,
  -1.7283393609872344,
  -0.9021821231503185,
  0.5129412507914956,
  -0.15014685388717008],
 [-1.1740393390490045,
  0.866849063342143,
  -0.9234243797410304,
  0.2014732901966383,
  0.47103683141802105,
  -0.6589581062151904],
 [0.9179264803176417,
  -2.174882502653097,
  1.924541590894679,
  0.4817938843209639,
  2.032142525959219,
  1.3106163894192329],
 [-1.962869120210299,
  0.0437026680842737,
  -1.5557085729518254,
  -0.9623655442413102,
  1.0736820120987525,
  -0.9037402860244345],
 [-1.5313557518250116,
  -0.908054043570438,
  -1.9675590504900051,
  -1.688902915245118,
  0.5610330674710605,
  -2.600903999054875],
 [-0.94350103557852,
  -0.2529193041069949,
  -1.401742691063514,
  0.014698272743938867,
  0.12743440666809006,
  -1.523444067549283],
 [-0.7442503914105747,
  1.2884063401784895,
  -0.9790012873131664,
  -0.7260417783673329,
  0.46451660524284916,
  -1.0373085427047914],
 [-0.7539020120039611,
  1.5628135662081106,
  1.865118993008001,
  -0.3879649701054999,
  0.5556402396335344,
  -0.015324675340545046],
 [0.6905781779406969,
  1.7061639733977114,
  -1.516843310925474,
  1.6521256643045672,
  0.5170157301179603,
  0.2249298623311664],
 [-1.3510371314676382,
  -0.9096929501484529,
  3.320758565521333,
  -1.351032987057183,
  0.6386236498376441,
  1.8811699313346835],
 [0.7907240736806046,
  -0.7794261958775333,
  -4.758432791497214,
  1.1150230439344688,
  -2.196514600832009,
  0.2784786731953025],
 [-0.7156192885747885,
  -0.2688341767951755,
  2.468433838814733,
  0.0381890368572666,
  -0.43986428761541757,
  0.4083077115549889],
 [1.6036734538798367,
  0.08703522814667258,
  -3.734886191939885,
  0.9464193629300054,
  -0.9473413799421244,
  1.2771355140607663],
 [-1.6183604419217068,
  -0.008790556303355637,
  1.9176986198690624,
  -1.4773212508411657,
  0.4514111986474981,
  -1.0096594908119336],
 [-0.08220194540269798,
  0.07526594592918776,
  1.5533222712669001,
  -0.1393859536266404,
  -0.8750086674580759,
  -1.0187528042170784],
 [-1.2899146170773808,
  -1.7295800930091456,
  0.8495775671046333,
  -1.1054221926247394,
  1.241713959652344,
  -1.5738095857950825],
 [0.9657255349904893,
  -0.329273707055818,
  -0.7862813483631217,
  1.302571997945923,
  -0.4702814467294437,
  0.8052421779346662],
 [0.4174195492497923,
  1.1819740486218142,
  -0.8701454397753758,
  1.1634613674840832,
  0.3581718453613483,
  0.5050681337615106],
 [1.6290228620714495,
  0.027264704818878514,
  0.20663276860320545,
  1.429160877134015,
  -0.13510030791493735,
  1.489300531435651],
 [-0.9379690923018869,
  1.2049706473007482,
  2.336195650829989,
  1.528022261536197,
  0.672425018895093,
  -0.7355818991508876],
 [-0.5066018513805834,
  2.0844772305415638,
  1.5908936270240566,
  -0.041595434905228545,
  1.3909034961852749,
  -0.915800778436904],
 [-0.8942686398004411,
  0.28598016618828376,
  -0.0823265243764133,
  -2.8336120072584143,
  1.7831128353750567,
  -1.46576698252871],
 [-1.3113190112602822,
  -1.0186194481044872,
  1.257527012347171,
  1.9594985843210018,
  2.9761969281549727,
  -1.3548463486464142],
 [-1.2465658756048734,
  1.1888010076522058,
  0.7067584135910586,
  -1.168103060609009,
  -0.04130843058077276,
  -1.551248874058262],
 [-0.8654724107174884,
  -2.007568021362774,
  1.736851344292579,
  -0.01123507783066835,
  1.0674561722347518,
  -1.3076835410962566],
 [-0.5783713813873501,
  0.7114542651948267,
  1.562616344744177,
  -0.9262670262008422,
  -0.28937794713269144,
  -1.5674004779383979],
 [1.904208405636648,
  0.6587051257097538,
  -1.841128863905451,
  2.3861492092241434,
  -0.9091576170851242,
  1.002015551057079],
 [0.155512746128743,
  -1.0546368888660922,
  -0.17596285902130293,
  0.4971253436454829,
  -0.7294741023038305,
  0.6617154951784303],
 [-0.3167818255844024,
  0.21586064818900524,
  2.014873414045711,
  -0.557500642965898,
  1.7089956631888337,
  -0.27577770539761204],
 [-0.31924792483714337,
  0.4753188602123068,
  1.6973949925348997,
  0.1374947972391124,
  1.318838621090771,
  0.7040696723175102],
 [-0.35907485324523947,
  -1.4152025195175149,
  2.692129453285837,
  -1.0996852315935712,
  0.5954011357104231,
  0.1297026599696498],
 [1.6648305259541865,
  1.4142512626124135,
  -0.5790273486541195,
  2.3314758417872508,
  -0.47358878097710866,
  0.9114276820923398],
 [0.20321569739425405,
  -0.19796296870131533,
  0.647944370969885,
  1.14966383390292,
  0.47682809432411033,
  -1.6813896514746394],
 [1.890442707053683,
  -0.40694423387208134,
  -0.40745999140167477,
  1.0223190828346203,
  -1.4522040434708976,
  1.639900316413544],
 [-1.9888686120731223,
  1.1895997812847487,
  -0.7115043899407414,
  -3.005300588529538,
  0.22333615869635526,
  -2.6769513833195373],
 [-2.773017754074956,
  -2.0791277229744964,
  1.1936219372838073,
  -3.060300494050681,
  -0.021474962374660032,
  -0.7407550698706757],
 [-0.8370702886509211,
  0.8158516204890898,
  -1.0345135677173216,
  -1.3787588729835338,
  0.5667559269188263,
  -2.225925176590633],
 [1.833545139228224,
  0.6433539310540702,
  -1.3732713953690063,
  1.2483166879490972,
  1.564704584933529,
  1.6315525231666226],
 [-1.4538996399876458,
  1.241970598009856,
  1.7574627707395485,
  -2.369658485355395,
  -0.08576316923283368,
  -0.8127826135651772]]


coeffs = [-0.6079036291968969,
  -0.7332156578254188,
  -0.03430319416616387,
  -1.0,
  -0.8100573569741444,
  -0.5751038587673778,
  -0.8333850175381974,
  -0.615471981177965,
  -1.0,
  -0.44111531884239497,
  -0.9189818746728284,
  -1.0,
  -0.339271717972203,
  -0.8280044126806466,
  -0.45030252630345585,
  -0.25388129235220647,
  -0.9054028974083799,
  -0.6076146839296285,
  -0.5381563535149948,
  -0.15617277290237447,
  -0.19407304647910764,
  -0.5717646591972249,
  -0.9793210620935077,
  -0.3397525799796951,
  -0.7040147809810671,
  -0.603571439777265,
  -0.7321308886020921,
  -0.8412347510925828,
  -1.0,
  -0.9060752762498449,
  -0.7339919328144365,
  -0.778868082566913,
  -0.2554872764542869,
  -0.939131804880842,
  -0.5146881095764453,
  -0.4692072662665083,
  -0.3758201738899835,
  -0.8624885861420862,
  0.3359938120098113,
  0.5474217005521093,
  0.9627532038385033,
  0.9843402416845081,
  0.6720664463848797,
  0.941429581144656,
  0.4267669884985995,
  1.0,
  0.987482757963522,
  0.06308227701585789,
  0.6063461403867276,
  0.6073241528911245,
  1.0,
  0.7588508842983271,
  1.0,
  1.0,
  0.8803949525240021,
  0.6320059418423961,
  0.14693258659952585,
  0.7137798253084232,
  1.0,
  0.5564723314235778,
  1.0,
  0.7034273372587609,
  0.5425005216403294,
  0.9753324242519615,
  0.7349048309267111,
  1.0,
  1.0,
  1.0,
  0.9367233152961184,
  0.7336340095287334]

np_sv = np.array(sv, dtype=np.double)
np_coeffs = np.array(coeffs, dtype=np.double)

initializers = [
    onnx.numpy_helper.from_array(np_sv, name='sv'),
    onnx.numpy_helper.from_array(np_coeffs, name='coeffs'),
    onnx.numpy_helper.from_array(np.array([0.5], dtype=np.double), name='kernel_set'),
    onnx.numpy_helper.from_array(np.array([-0.0606952], dtype=np.double), name='bias')
]

inputs = [
    onnx.helper.make_tensor_value_info('cc', onnx.TensorProto.STRING, [1]),
    onnx.helper.make_tensor_value_info('mk', onnx.TensorProto.STRING, [1]),
    onnx.helper.make_tensor_value_info('rk', onnx.TensorProto.STRING, [1]),
    onnx.helper.make_tensor_value_info('in', onnx.TensorProto.STRING, [1]),
    onnx.helper.make_tensor_value_info('pk', onnx.TensorProto.STRING, [1]),
]
outputs = [onnx.helper.make_tensor_value_info('out', onnx.TensorProto.STRING, [1])]
nodes = [
    onnx.helper.make_node('fhe.ckks.loader', ['cc', 'rk', 'mk', 'in', 'pk'], ['cctx', 'icphr', 'pubkey'], domain='fhe.ckks.loader'),
    onnx.helper.make_node('fhe.ckks.svm', ['cctx', 'icphr', 'pubkey', 'sv', 'kernel_set', 'coeffs', 'bias'], ['svm-out'], domain='fhe.ckks.svm', kernel_type='rbf'),
    onnx.helper.make_node('fhe.ckks.saver', ['svm-out'], ['out'], domain='fhe.ckks.saver'),
]
graph = onnx.helper.make_graph(nodes, 'svm-example', inputs=inputs, outputs=outputs, initializer=initializers)

onnx_opset = OperatorSetIdProto()
onnx_opset.domain = ''  
onnx_opset.version = 22

matmul = OperatorSetIdProto()
matmul.domain = 'fhe.ckks.svm'
matmul.version = 1 

loader = OperatorSetIdProto()
loader.domain = 'fhe.ckks.loader'
loader.version = 1

saver = OperatorSetIdProto()
saver.domain = 'fhe.ckks.saver'
saver.version = 1

model = onnx.helper.make_model(graph, opset_imports=[onnx_opset, matmul, loader, saver])
model.ir_version = 10

mstr = model.SerializeToString()
with open('fhe-svm-rbf.onnx', 'wb') as f:
    f.write(mstr)
